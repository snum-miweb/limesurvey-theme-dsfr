{#
    LimeSurvey
    Copyright (C) 2007-2017 The LimeSurvey Project Team / Louis Gac
    All rights reserved.
    License: GNU/GPL License v2 or later, see LICENSE.php
    LimeSurvey is free software. This version may have been modified pursuant
    to the GNU General Public License, and as distributed it includes or
    is derivative of works licensed under the GNU General Public License or
    other free or open source software licenses.
    See COPYRIGHT.php for copyright notices and details.

    (¯`·._.·(¯`·._.· Content First Page  ·._.·´¯)·._.·´¯)

    This content is included inside mainrow.twig

#}

{# render the layout_global content block #}

{# Include the alert for no JavaScript #}
{{ include('./subviews/messages/no_js_alert.twig') }}

{# Include the language changer selector - MASQUÉ : déjà présent dans le header #}
{# {{ include('./subviews/navigation/language_changer_first_page.twig') }} #}

{# Vérifier si la protection anti-bot est activée #}
{% set antibotEnabled = aSurveyInfo.options.antibot_enabled|default('off') == 'on' %}

{% if antibotEnabled %}
    {# Conteneur pour la page anti-bot (affiché par défaut si anti-bot activé) #}
    <div id="antibot-page-wrapper">
        {{ include('./subviews/antibot/antibot_challenge.twig') }}
    </div>

    {# Conteneur pour la page de bienvenue (caché par défaut si anti-bot activé) #}
    <div id="welcome-page-wrapper" style="display: none;">
{% endif %}

{# Include the form opening tag #}
{{ include('./subviews/header/start_form.twig') }} <!-- main form -->

    {# This will display the script and the hidden inputs needed for ExpressionScript Engine #}
    {{ aSurveyInfo.EM.ScriptsAndHiddenInputs  }}

    {# If survey mode is "All in One", this will add the welcome/privacy messages (if activated) #}
    {{ include('./subviews/messages/welcome.twig') }}

    {{ include('./subviews/privacy/privacy.twig') }}

    {# Presents the navigator #}
    {{ include('./subviews/navigation/navigator.twig') }}
</form> <!-- main form -->

{% if antibotEnabled %}
    </div> {# Fermeture du welcome-page-wrapper #}

    {# Script pour gérer l'affichage conditionnel basé sur sessionStorage #}
    <script>
    (function() {
        'use strict';
        var surveyId = '{{ aSurveyInfo.sid }}';
        var storageKey = 'antibot_validated_' + surveyId;

        // Vérifier si déjà validé (via sessionStorage)
        try {
            var validated = sessionStorage.getItem(storageKey);
            if (validated) {
                // Déjà validé - afficher directement la page de bienvenue
                var antibotWrapper = document.getElementById('antibot-page-wrapper');
                var welcomeWrapper = document.getElementById('welcome-page-wrapper');
                if (antibotWrapper) antibotWrapper.style.display = 'none';
                if (welcomeWrapper) welcomeWrapper.style.display = 'block';
            }
        } catch(e) {
            // sessionStorage non disponible - laisser la page anti-bot visible
        }

        // Fonction pour basculer vers la page de bienvenue (appelée depuis antibot_challenge.twig)
        window.showWelcomePage = function() {
            var antibotWrapper = document.getElementById('antibot-page-wrapper');
            var welcomeWrapper = document.getElementById('welcome-page-wrapper');

            if (antibotWrapper) {
                antibotWrapper.style.opacity = '0';
                antibotWrapper.style.transition = 'opacity 0.3s ease';
            }

            setTimeout(function() {
                if (antibotWrapper) antibotWrapper.style.display = 'none';
                if (welcomeWrapper) {
                    welcomeWrapper.style.display = 'block';
                    welcomeWrapper.style.opacity = '0';
                    welcomeWrapper.style.transition = 'opacity 0.3s ease';
                    setTimeout(function() {
                        welcomeWrapper.style.opacity = '1';
                    }, 50);
                }

                // Scroll vers le haut
                window.scrollTo({ top: 0, behavior: 'smooth' });

                // Focus sur le titre pour l'accessibilité
                var mainTitle = welcomeWrapper.querySelector('h1');
                if (mainTitle) {
                    mainTitle.setAttribute('tabindex', '-1');
                    mainTitle.focus();
                }
            }, 300);
        };
    })();
    </script>
{% endif %}

{{ registerScript("BasicFirstPageThemeScripts", "
    if(window.basicThemeScripts === undefined){
        window.basicThemeScripts = new ThemeScripts();
    }
", 'POS_POSTSCRIPT') }}
